From 4a688e1fe722f8d820ffe982995a532890812db6 Mon Sep 17 00:00:00 2001
From: Philippe Sauter <phsauter@iis.ee.ethz.ch>
Date: Fri, 19 Dec 2025 16:51:35 +0100
Subject: [PATCH] remove files and move includes

---
 cve2_core.f                                   |  17 -
 cve2_clock_gate.sv                            | 36 ------------------------------------
 cve2_top_tracing.sv => cve2_core_tracing.sv   |  41 ++-
 cve2_cs_registers.sv                          |   2 +-
 cve2_top.sv                                   | 304 ------------------
 .../cve2/cve2_pmp_reset_default.svh           |   0
 6 files changed, 28 insertions(+), 372 deletions(-)
 delete mode 100644 rtl/cve2_core.f
 delete mode 100644 rtl/cve2_clock_gate.sv
 rename rtl/{cve2_top_tracing.sv => cve2_core_tracing.sv} (84%)
 delete mode 100644 rtl/cve2_top.sv
 rename rtl/{ => include/cve2}/cve2_pmp_reset_default.svh (100%)

diff --git a/cve2_core.f b/cve2_core.f
deleted file mode 100644
index 3250f707..00000000
--- a/cve2_core.f
+++ /dev/null
@@ -1,17 +0,0 @@
-cve2_pkg.sv
-cve2_alu.sv
-cve2_compressed_decoder.sv
-cve2_controller.sv
-cve2_counter.sv
-cve2_cs_registers.sv
-cve2_decoder.sv
-cve2_ex_block.sv
-cve2_id_stage.sv
-cve2_if_stage.sv
-cve2_load_store_unit.sv
-cve2_multdiv_slow.sv
-cve2_multdiv_fast.sv
-cve2_prefetch_buffer.sv
-cve2_fetch_fifo.sv
-cve2_register_file_ff.sv
-cve2_core.sv
diff --git a/cve2_clock_gate.sv b/cve2_clock_gate.sv
deleted file mode 100644
index 949e5048..00000000
--- a/cve2_clock_gate.sv
+++ /dev/null
@@ -1,36 +0,0 @@
-// Copyright (c) 2025 Eclipse Foundation
-// Copyright 2017 ETH Zurich and University of Bologna.
-// Copyright and related rights are licensed under the Solderpad Hardware
-// License, Version 0.51 (the "License"); you may not use this file except in
-// compliance with the License.  You may obtain a copy of the License at
-// http://solderpad.org/licenses/SHL-0.51. Unless required by applicable law
-// or agreed to in writing, software, hardware and materials distributed under
-// this License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
-// CONDITIONS OF ANY KIND, either express or implied. See the License for the
-// specific language governing permissions and limitations under the License.
-
-// !!! cve2_clock_gate file is meant for simulation only !!!
-// !!! It must not be used for ASIC synthesis                    !!!
-// !!! It must not be used for FPGA synthesis                    !!!
-
-module cve2_clock_gate (
-    input  logic clk_i,
-    input  logic en_i,
-    input  logic scan_cg_en_i,
-    output logic clk_o
-);
-
-  // `ifdef SYNTHESIS
-  //   $error("cve2_clock_gate module is meant for simulation only. \
-  //          It should not be used for ASIC or FPGA synthesis");
-  // `endif
-
-  logic clk_en;
-
-  always_latch begin
-    if (clk_i == 1'b0) clk_en <= en_i | scan_cg_en_i;
-  end
-
-  assign clk_o = clk_i & clk_en;
-
-endmodule  // cve2_clock_gate
diff --git a/cve2_top_tracing.sv b/cve2_core_tracing.sv
similarity index 84%
rename from cve2_top_tracing.sv
rename to cve2_core_tracing.sv
index 1f92346a..efc157c0 100644
--- a/cve2_top_tracing.sv
+++ b/cve2_core_tracing.sv
@@ -7,19 +7,24 @@
  * Top level module of the cve2 RISC-V core with tracing enabled
  */
 
-module cve2_top_tracing import cve2_pkg::*; #(
-  parameter int unsigned MHPMCounterNum   = 10,
-  parameter int unsigned MHPMCounterWidth = 40,
-  parameter bit          RV32E            = 1'b0,
-  parameter rv32m_e      RV32M            = RV32MFast
+module cve2_core_tracing import cve2_pkg::*; #(
+  parameter bit          PMPEnable         = 1'b0,
+  parameter int unsigned PMPGranularity    = 0,
+  parameter int unsigned PMPNumRegions     = 4,
+  parameter int unsigned MHPMCounterNum    = 10,
+  parameter int unsigned MHPMCounterWidth  = 40,
+  parameter bit          RV32E             = 1'b0,
+  parameter rv32m_e      RV32M             = RV32MFast,
+  parameter rv32b_e      RV32B             = RV32BNone,
+  parameter bit          DbgTriggerEn      = 1'b0,
+  parameter int unsigned DbgHwBreakNum     = 1,
+  parameter bit          XInterface        = 1'b0
 ) (
   // Clock and Reset
   input  logic                         clk_i,
   input  logic                         rst_ni,
 
   input  logic                         test_en_i,     // enable all clock gates for testing
-  input  prim_ram_1p_pkg::ram_1p_cfg_t ram_cfg_i,
-
 
   input  logic [31:0]                  hart_id_i,
   input  logic [31:0]                  boot_addr_i,
@@ -68,6 +73,7 @@ module cve2_top_tracing import cve2_pkg::*; #(
   input  logic                         irq_external_i,
   input  logic [15:0]                  irq_fast_i,
   input  logic                         irq_nm_i,       // non-maskeable interrupt
+  output logic                         irq_pending_o,
 
   // Debug Interface
   input  logic                         debug_req_i,
@@ -78,7 +84,7 @@ module cve2_top_tracing import cve2_pkg::*; #(
 
   // CPU Control Signals
   input  logic                         fetch_enable_i,
-  output logic                         core_sleep_o
+  output logic                         core_busy_o,
 
 );
 
@@ -127,12 +133,19 @@ module cve2_top_tracing import cve2_pkg::*; #(
   assign unused_rvfi_ext_debug_req = rvfi_ext_debug_req;
   assign unused_rvfi_ext_mcycle = rvfi_ext_mcycle;
 
-  cve2_top #(
+  cve2_core #(
+    .PMPEnable        ( PMPEnable        ),
+    .PMPGranularity   ( PMPGranularity   ),
+    .PMPNumRegions    ( PMPNumRegions    ),
     .MHPMCounterNum   ( MHPMCounterNum   ),
     .MHPMCounterWidth ( MHPMCounterWidth ),
     .RV32E            ( RV32E            ),
-    .RV32M            ( RV32M            )
-  ) u_cve2_top (
+    .RV32M            ( RV32M            ),
+    .RV32B            ( RV32B            ),
+    .DbgTriggerEn     ( DbgTriggerEn     ),
+    .DbgHwBreakNum    ( DbgHwBreakNum    ),
+    .XInterface       ( XInterface       )
+  ) u_cve2_core (
     .clk_i,
     .rst_ni,
 
@@ -183,6 +196,7 @@ module cve2_top_tracing import cve2_pkg::*; #(
     .irq_external_i,
     .irq_fast_i,
     .irq_nm_i,
+    .irq_pending_o,
 
     .debug_req_i,
     .debug_halted_o,
@@ -219,11 +233,10 @@ module cve2_top_tracing import cve2_pkg::*; #(
     .rvfi_ext_mcycle,
 
     .fetch_enable_i,
-    .core_sleep_o
+    .core_busy_o
   );
 
-  cve2_tracer
-  u_cve2_tracer (
+  cve2_tracer u_cve2_tracer (
     .clk_i,
     .rst_ni,
 
diff --git a/cve2_cs_registers.sv b/cve2_cs_registers.sv
index f811ce13..51aa5d3b 100644
--- a/cve2_cs_registers.sv
+++ b/cve2_cs_registers.sv
@@ -972,7 +972,7 @@ import cve2_pkg::*;
     `ifdef CVE2_CUSTOM_PMP_RESET_VALUES
       `include "cve2_pmp_reset.svh"
     `else
-      `include "cve2_pmp_reset_default.svh"
+      `include "cve2/cve2_pmp_reset_default.svh"
     `endif
 
     pmp_mseccfg_t                pmp_mseccfg_q, pmp_mseccfg_d;
diff --git a/cve2_top.sv b/cve2_top.sv
deleted file mode 100644
index f8442e68..00000000
--- a/cve2_top.sv
+++ /dev/null
@@ -1,304 +0,0 @@
-// Copyright (c) 2025 Eclipse Foundation
-// Copyright 2023 OpenHW Group.
-// Copyright lowRISC contributors.
-// Copyright 2018 ETH Zurich and University of Bologna, see also CREDITS.md.
-// Licensed under the Apache License, Version 2.0, see LICENSE for details.
-// SPDX-License-Identifier: Apache-2.0
-
-`ifdef RISCV_FORMAL
-  `define RVFI
-`endif
-
-`include "lowrisc_prim/prim_assert.svh"
-
-/**
- * Top level module of the CVE2 RISC-V core
- */
-module cve2_top import cve2_pkg::*; #(
-  parameter int unsigned MHPMCounterNum   = 10,
-  parameter int unsigned MHPMCounterWidth = 40,
-  parameter bit          RV32E            = 1'b0,
-  parameter rv32m_e      RV32M            = RV32MFast,
-  parameter bit          XInterface       = 1'b0
-) (
-  // Clock and Reset
-  input  logic                         clk_i,
-  input  logic                         rst_ni,
-
-  input  logic                         test_en_i,     // enable all clock gates for testing
-
-  input  logic [31:0]                  hart_id_i,
-  input  logic [31:0]                  boot_addr_i,
-
-  // Instruction memory interface
-  output logic                         instr_req_o,
-  input  logic                         instr_gnt_i,
-  input  logic                         instr_rvalid_i,
-  output logic [31:0]                  instr_addr_o,
-  input  logic [31:0]                  instr_rdata_i,
-  input  logic                         instr_err_i,
-
-  // Data memory interface
-  output logic                         data_req_o,
-  input  logic                         data_gnt_i,
-  input  logic                         data_rvalid_i,
-  output logic                         data_we_o,
-  output logic [3:0]                   data_be_o,
-  output logic [31:0]                  data_addr_o,
-  output logic [31:0]                  data_wdata_o,
-  input  logic [31:0]                  data_rdata_i,
-  input  logic                         data_err_i,
-
-  // Core-V Extension Interface (CV-X-IF)
-  // Issue Interface
-  output logic                         x_issue_valid_o,
-  input  logic                         x_issue_ready_i,
-  output x_issue_req_t                 x_issue_req_o,
-  input  x_issue_resp_t                x_issue_resp_i,
-
-  // Register Interface
-  output x_register_t                  x_register_o,
-
-  // Commit Interface
-  output logic                         x_commit_valid_o,
-  output x_commit_t                    x_commit_o,
-
-  // Result Interface
-  input  logic                         x_result_valid_i,
-  output logic                         x_result_ready_o,
-  input  x_result_t                    x_result_i,
-
-  // Interrupt inputs
-  input  logic                         irq_software_i,
-  input  logic                         irq_timer_i,
-  input  logic                         irq_external_i,
-  input  logic [15:0]                  irq_fast_i,
-  input  logic                         irq_nm_i,       // non-maskeable interrupt
-
-  // Debug Interface
-  input  logic                         debug_req_i,
-  output logic                         debug_halted_o,
-  input  logic [31:0]                  dm_halt_addr_i,
-  input  logic [31:0]                  dm_exception_addr_i,
-  output crash_dump_t                  crash_dump_o,
-
-  // RISC-V Formal Interface
-  // Does not comply with the coding standards of _i/_o suffixes, but follows
-  // the convention of RISC-V Formal Interface Specification.
-`ifdef RVFI
-  output logic                         rvfi_valid,
-  output logic [63:0]                  rvfi_order,
-  output logic [31:0]                  rvfi_insn,
-  output logic                         rvfi_trap,
-  output logic                         rvfi_halt,
-  output logic                         rvfi_intr,
-  output logic [ 1:0]                  rvfi_mode,
-  output logic [ 1:0]                  rvfi_ixl,
-  output logic [ 4:0]                  rvfi_rs1_addr,
-  output logic [ 4:0]                  rvfi_rs2_addr,
-  output logic [ 4:0]                  rvfi_rs3_addr,
-  output logic [31:0]                  rvfi_rs1_rdata,
-  output logic [31:0]                  rvfi_rs2_rdata,
-  output logic [31:0]                  rvfi_rs3_rdata,
-  output logic [ 4:0]                  rvfi_rd_addr,
-  output logic [31:0]                  rvfi_rd_wdata,
-  output logic [31:0]                  rvfi_pc_rdata,
-  output logic [31:0]                  rvfi_pc_wdata,
-  output logic [31:0]                  rvfi_mem_addr,
-  output logic [ 3:0]                  rvfi_mem_rmask,
-  output logic [ 3:0]                  rvfi_mem_wmask,
-  output logic [31:0]                  rvfi_mem_rdata,
-  output logic [31:0]                  rvfi_mem_wdata,
-  output logic [31:0]                  rvfi_ext_mip,
-  output logic                         rvfi_ext_nmi,
-  output logic                         rvfi_ext_debug_req,
-  output logic [63:0]                  rvfi_ext_mcycle,
-`endif
-
-  // CPU Control Signals
-  input  logic                         fetch_enable_i,
-  output logic                         core_sleep_o
-);
-
-  // Scrambling Parameter
-  localparam int unsigned NumAddrScrRounds  = 0;
-
-  // Physical Memory Protection (always disabled following PVL-40)
-  localparam bit          PMPEnable        = 1'b0;
-  localparam int unsigned PMPGranularity   = 0;
-  localparam int unsigned PMPNumRegions    = 4;
-
-  // Trigger support
-  localparam bit          DbgTriggerEn     = 1'b1; // DEBUG_TRIGGER_EN in CVE4
-  localparam int unsigned DbgHwBreakNum    = 1;
-
-  // Bit manipulation extension
-  localparam rv32b_e      RV32B            = RV32BNone;
-
-  // Clock signals
-  logic                        clk;
-  logic                        core_busy_d, core_busy_q;
-  logic                        clock_en;
-  logic                        fetch_enable_d, fetch_enable_q;
-  logic                        irq_pending;
-
-  /////////////////////
-  // Main clock gate //
-  /////////////////////
-
-  always_ff @(posedge clk_i or negedge rst_ni) begin
-    if (!rst_ni) begin
-      core_busy_q <= 1'b0;
-      fetch_enable_q <= 1'b0;
-    end else begin
-      core_busy_q <= core_busy_d;
-      fetch_enable_q <= fetch_enable_d;
-    end
-  end
-
-  assign clock_en = fetch_enable_q & (core_busy_q | debug_req_i | irq_pending | irq_nm_i);
-  assign core_sleep_o = fetch_enable_q & !clock_en;
-  assign fetch_enable_d = fetch_enable_i ? 1'b1 : fetch_enable_q;
-
-  cve2_clock_gate core_clock_gate_i (
-    .clk_i    (clk_i),
-    .en_i     (clock_en),
-    .scan_cg_en_i(test_en_i),
-    .clk_o    (clk)
-  );
-
-  ////////////////////////
-  // Core instantiation //
-  ////////////////////////
-
-  cve2_core #(
-    .PMPEnable        (PMPEnable),
-    .PMPGranularity   (PMPGranularity),
-    .PMPNumRegions    (PMPNumRegions),
-    .MHPMCounterNum   (MHPMCounterNum),
-    .MHPMCounterWidth (MHPMCounterWidth),
-    .RV32E            (RV32E),
-    .RV32M            (RV32M),
-    .RV32B            (RV32B),
-    .DbgTriggerEn     (DbgTriggerEn),
-    .DbgHwBreakNum    (DbgHwBreakNum),
-    .XInterface       (XInterface)
-  ) u_cve2_core (
-    .clk_i(clk),
-    .rst_ni,
-    .test_en_i,
-
-    .hart_id_i,
-    .boot_addr_i,
-
-    .instr_req_o,
-    .instr_gnt_i,
-    .instr_rvalid_i,
-    .instr_addr_o,
-    .instr_rdata_i,
-    .instr_err_i,
-
-    .data_req_o,
-    .data_gnt_i,
-    .data_rvalid_i,
-    .data_we_o,
-    .data_be_o,
-    .data_addr_o,
-    .data_wdata_o,
-    .data_rdata_i,
-    .data_err_i,
-
-    // Core-V Extension Interface (CV-X-IF)
-    // Issue Interface
-    .x_issue_valid_o,
-    .x_issue_ready_i,
-    .x_issue_req_o,
-    .x_issue_resp_i,
-
-    // Register Interface
-    .x_register_o,
-
-    // Commit Interface
-    .x_commit_valid_o,
-    .x_commit_o,
-
-    // Result Interface
-    .x_result_valid_i,
-    .x_result_ready_o,
-    .x_result_i,
-
-    .irq_software_i,
-    .irq_timer_i,
-    .irq_external_i,
-    .irq_fast_i,
-    .irq_nm_i,
-    .irq_pending_o(irq_pending),
-
-    .debug_req_i,
-    .debug_halted_o,
-    .dm_halt_addr_i,
-    .dm_exception_addr_i,
-    .crash_dump_o,
-
-`ifdef RVFI
-    .rvfi_valid,
-    .rvfi_order,
-    .rvfi_insn,
-    .rvfi_trap,
-    .rvfi_halt,
-    .rvfi_intr,
-    .rvfi_mode,
-    .rvfi_ixl,
-    .rvfi_rs1_addr,
-    .rvfi_rs2_addr,
-    .rvfi_rs3_addr,
-    .rvfi_rs1_rdata,
-    .rvfi_rs2_rdata,
-    .rvfi_rs3_rdata,
-    .rvfi_rd_addr,
-    .rvfi_rd_wdata,
-    .rvfi_pc_rdata,
-    .rvfi_pc_wdata,
-    .rvfi_mem_addr,
-    .rvfi_mem_rmask,
-    .rvfi_mem_wmask,
-    .rvfi_mem_rdata,
-    .rvfi_mem_wdata,
-    .rvfi_ext_mip,
-    .rvfi_ext_nmi,
-    .rvfi_ext_debug_req,
-    .rvfi_ext_mcycle,
-`endif
-
-    .fetch_enable_i (fetch_enable_q),
-    .core_busy_o    (core_busy_d)
-  );
-
-  // X checks for top-level outputs
-  `ASSERT_KNOWN(CVE2InstrReqX, instr_req_o)
-  `ASSERT_KNOWN_IF(CVE2InstrReqPayloadX, instr_addr_o, instr_req_o)
-
-  `ASSERT_KNOWN(CVE2DataReqX, data_req_o)
-  `ASSERT_KNOWN_IF(CVE2DataReqPayloadX,
-    {data_we_o, data_be_o, data_addr_o, data_wdata_o}, data_req_o)
-
-  `ASSERT_KNOWN(CVE2CoreSleepX, core_sleep_o)
-
-  // X check for top-level inputs
-  `ASSERT_KNOWN(CVE2TestEnX, test_en_i)
-  `ASSERT_KNOWN(CVE2RamCfgX, ram_cfg_i)
-  `ASSERT_KNOWN(CVE2HartIdX, hart_id_i)
-  `ASSERT_KNOWN(CVE2BootAddrX, boot_addr_i)
-
-  `ASSERT_KNOWN(CVE2InstrGntX, instr_gnt_i)
-  `ASSERT_KNOWN(CVE2InstrRValidX, instr_rvalid_i)
-  `ASSERT_KNOWN_IF(CVE2InstrRPayloadX,
-    {instr_rdata_i, instr_err_i}, instr_rvalid_i)
-
-  `ASSERT_KNOWN(CVE2DataGntX, data_gnt_i)
-  `ASSERT_KNOWN(CVE2DataRValidX, data_rvalid_i)
-
-  `ASSERT_KNOWN(CVE2IrqX, {irq_software_i, irq_timer_i, irq_external_i, irq_fast_i, irq_nm_i})
-
-  `ASSERT_KNOWN(CVE2DebugReqX, debug_req_i)
-endmodule
diff --git a/cve2_pmp_reset_default.svh b/include/cve2/cve2_pmp_reset_default.svh
similarity index 100%
rename from cve2_pmp_reset_default.svh
rename to include/cve2/cve2_pmp_reset_default.svh
-- 
2.43.5

